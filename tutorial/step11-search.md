# Шаг 11: Возможности NetBox v3.4

Версия NetBox 3.4, выпущенная в декабре 2022 года, представила значительно улучшенную глобальную поисковую систему, которая включает в себя возможность для плагинов регистрировать свои собственные модели. На этом этапе мы добавим индексаторы поиска для наших пользовательских моделей, чтобы они отображались в результатах глобального поиска NetBox.

:warning: **Внимание:** Для этой функции требуется NetBox v3.4 или более поздняя версия. Если вы еще этого не сделали, обязательно установите `min_version = '3.4.0'` в `NetBoxAccessListsConfig`.

:blue_square: **Примечание:** Если вы пропустили предыдущий шаг, запустите `git checkout Step10-graphql`.

## Создание поисковых индексов

Наш плагин имеет две модели: AccessList и AccessListRule. Мы хотели бы, чтобы пользователи могли искать экземпляры обеих моделей, используя функцию глобального поиска NetBox. Чтобы это реализовать, нам нужно объявить и зарегистрировать подкласс SearchIndex для каждой модели.

Начните с создания `search.py` в корневом каталоге плагина рядом с `models.py`.

```bash
$ cd netbox_access_lists/
$ edit search.py
```

В этот файл мы импортируем класс NetBox SearchIndex, а также наши собственные модели. Затем мы создадим подкласс SearchIndex для каждой модели:

```python
from netbox.search import SearchIndex
from .models import AccessList, AccessListRule

class AccessListIndex(SearchIndex):
    model = AccessList

class AccessListRuleIndex(SearchIndex):
    model = AccessListRule
```

Однако есть еще кое-что для включения поиска. Нам также нужно указать NetBox, в каких полях искать каждую модель и насколько важно каждое поле (также известное как его _приоритет_). Последнее достигается путем присвоения числового веса.

Рассмотрим нашу модель AccessList. Он имеет три интересных поля базы данных: «имя», «default_action» и «комментарии». Как нам следует относиться к ним при поиске объектов в NetBox? Это может быть несколько субъективно, но обычно мы хотим назначать более высокий приоритет (_меньший_ вес) важным полям и опускать поля, которые нас не волнуют. Если вы не уверены, какой вес назначить, просмотрите базовый код NetBox и найдите подобные примеры.

* `name`: это важное поле, поэтому мы присвоим ему высокий приоритет - `100`.
* `default_action` Это поле выбора выбора. Хотя это очень полезно для _фильтрации_, мы обычно не ожидаем, что пользователи будут искать эти значения. Мы исключим это поле из индекса поиска.
* `комментарии`: всегда рекомендуется включать комментарии пользователей в индекс поиска, однако мы назначим этому полю гораздо более низкий приоритет - `5000`, поскольку любые совпадения с меньшей вероятностью будут релевантными.

После выбора полей поиска и их приоритета у нас должно получиться что-то вроде этого:

```python
class AccessListIndex(SearchIndex):
    model = AccessList
    fields = (
        ('name', 100),
        ('comments', 5000),
    )

class AccessListRuleIndex(SearchIndex):
    model = AccessListRule
    fields = (
        ('description', 500),
    )
```

Почему мы исключили параметры источника и назначения из AccessListRuleIndex? Префиксы источника и назначения являются связанными объектами, поэтому мы хотим избежать локального кэширования их значений: если связанный объект будет изменен, наша кэшированная копия может устареть. И мы опускаем номера портов источника и назначения, поскольку сопоставление общих целочисленных значений может привести к множеству нерелевантных результатов поиска. Все эти значения лучше сопоставлять с помощью специальных фильтров, а не поиска общего назначения.

## Зарегистрируйте индексаторы

Наконец, нам нужно зарегистрировать наши индексаторы, чтобы NetBox мог их запускать. В верхней части `search.py` импортируйте декоратор `register_search`. Затем используйте его, чтобы обернуть оба наших индексных класса:

```python
from netbox.search import SearchIndex, register_search
from .models import AccessList, AccessListRule

@register_search
class AccessListIndex(SearchIndex):
    model = AccessList
    fields = (
        ('name', 100),
        ('comments', 5000),
    )

@register_search
class AccessListRuleIndex(SearchIndex):
    model = AccessListRule
    fields = (
        ('description', 500),
    )
```

Теперь, когда наши индексаторы зарегистрированы, мы можем запустить команду управления reindex для индексации любых существующих объектов. (Новые объекты, созданные с этого момента, будут автоматически регистрироваться при создании.)

```
$ ./manage.py reindex netbox_access_lists
Reindexing 2 models.
Indexing models
  netbox_access_lists.accesslist... 1 entries cached.
  netbox_access_lists.accesslistrule... 3 entries cached.
```

Теперь мы можем искать списки доступа и правила, используя функцию глобального поиска NetBox.

![Search results](/images/step11-search-results.png)

<div align="center">

:arrow_left: [Step 10: GraphQL API](/tutorial/step10-graphql-api.md)

</div>
